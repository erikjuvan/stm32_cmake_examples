////////////////////////////////////////////////////////////////////////////////
// COPYRIGHT (c) 2020
// EMTAS, EMSISO
// All rights reserved.
////////////////////////////////////////////////////////////////////////////////
/**
*@file   co_nmtmaster.c
*@brief  contains NMT master services
*@author Zdenko Mezgec
*@author EMTAS
*@date   03.12.2020
*/
////////////////////////////////////////////////////////////////////////////////
/**
*@addtogroup CANOPEN
* @{ <!-- BEGIN GROUP -->
*/
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Includes
////////////////////////////////////////////////////////////////////////////////
#include "gen_define.h" /*lint !e766 depends on configuration */
#include "co_datatype.h"
#include "co_drv.h"
#include "co_timer.h"
#include "ico_cobhandler.h"
#include "ico_queue.h"
#include "ico_nmt.h"

////////////////////////////////////////////////////////////////////////////////
// Definitions
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Variables
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Function prototypes
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Functions
////////////////////////////////////////////////////////////////////////////////

/***************************************************************************/
/**
* \internal
*
* \brief coNmtStateReq - request NMT state change
*
*
* \return RET_T
*
*/
RET_T coNmtStateReq(
		UNSIGNED8		node,			/* node */
		CO_NMT_STATE_T	reqState,		/* new requested state */
		BOOL_T			master			/* valid for master */
	)
{
    CO_TRANS_DATA_T trData;
    COB_REFERENZ_T	cobRef;
    UNSIGNED8		cmd;
	
	switch (reqState)  {
		case CO_NMT_STATE_OPERATIONAL:
			cmd = 1u;
			break;
		case CO_NMT_STATE_STOPPED:
			cmd = 2u;
			break;
		case CO_NMT_STATE_PREOP:
			cmd = 128u;
			break;
		case CO_NMT_STATE_RESET_NODE:
			cmd = 129u;
			break;
		case CO_NMT_STATE_RESET_COMM:
			cmd = 130u;
			break;
		case CO_NMT_STATE_UNKNOWN:
		default:
			return(RET_INVALID_PARAMETER);
	}

	cobRef = icoGetNmtCobMaster();
	/* own node requested ? */
	if (node == coNmtGetNodeId()) {
		master = CO_TRUE;	
	} else {
		trData.data[0] = cmd;
		trData.data[1] = node;
		(void)icoTransmitMessage(cobRef, &trData, 0u);
	}

	return(RET_OK);
}
////////////////////////////////////////////////////////////////////////////////
/**
* @} <!-- END GROUP -->
*/
////////////////////////////////////////////////////////////////////////////////
